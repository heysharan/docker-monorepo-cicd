FROM oven/bun:latest

WORKDIR /usr/src/app
RUN apt-get update -y && apt-get install -y openssl && rm -rf /var/lib/apt/lists/*

COPY ./package.json ./bun.lock ./turbo.json ./
COPY ./packages ./packages
COPY ./apps/web ./apps/web

RUN bun install

RUN --mount=type=secret,id=database_url \
    DATABASE_URL=$(cat /run/secrets/database_url) bun run db:generate && \
    DATABASE_URL=$(cat /run/secrets/database_url) bun run build

EXPOSE 3000
CMD ["bun", "start:web"]
